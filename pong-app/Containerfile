#
# Containerfile for building a Go application using distroless base image
# Log Output Application for DevOps with Kubernetes course

# Build stage
FROM golang:1.25.3-alpine AS builder

WORKDIR /log_app

ARG COMMIT_SHA
ARG COMMIT_TAG
ARG DEBUG=false

# Copy go mod and sum files
COPY go.mod go.sum ./
RUN go mod download

# Copy source code
COPY . .

# Build the Go app (static binary)
RUN CGO_ENABLED=0 GOOS=linux sh -c '\
  LDFLAGS="-X main.COMMIT_SHA=${COMMIT_SHA} -X main.COMMIT_TAG=${COMMIT_TAG}"; \
  if [ "${DEBUG}" != "true" ]; then \
    LDFLAGS="-s -w -buildid= ${LDFLAGS}"; \
  fi; \
  go build -trimpath -ldflags "$LDFLAGS" -o server main.go'

# Final stage: distroless
FROM scratch
USER 1000:1000
WORKDIR /app

COPY --from=builder /log_app/server .

# Run the binary
ENTRYPOINT ["/app/server", "/data/counter.txt"]
